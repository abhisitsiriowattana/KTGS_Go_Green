<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KTGS Go Green</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.27.0/sdk.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #f5f6fa; overscroll-behavior: none; }
    body { font-family: 'Sarabun', Arial, sans-serif; min-height: 100vh; background: #f5f6fa; box-sizing: border-box; }
    .main-bg { background: #61cbf8; height: 170px; width: 100vw; border-radius: 0 0 32px 32px; position: absolute; top: 0; left: 0; z-index: 1; min-width: 100vw; }
    .container { position: relative; max-width: 450px; width: 100vw; min-height: 100vh; margin: 0 auto; background: #fff; border-radius: 0 0 24px 24px; box-shadow: 0 2px 16px #1e90ff12; padding: 0 0 32px 0; z-index: 2; display: flex; flex-direction: column; align-items: center; }
    .logo-top { text-align: center; margin-bottom: 12px; width: 100%; padding-top: 38px; }
    .logo-top img { width: 278px; height: 105px; border-radius: 18px; background: #fff; box-shadow: 0 1px 8px #1e90ff22; object-fit: cover; border: 3px solid #e6e6e6; display: inline-block; max-width: 85vw; max-height: 25vw; }
    .main-title { text-align: center; font-size: 2.15rem; color: #4DC247; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; margin-top: 0; position: relative; z-index: 2; font-family: inherit; }
    .tabs-ui { display: flex; justify-content: center; width: 100%; margin-bottom: 18px; margin-top: 2px; border-radius: 12px; overflow: hidden; background: #ebebeb; border: 1px solid #e3e3e3; max-width: 400px; margin-left: auto; margin-right: auto; }
    .tab-ui { flex: 1; padding: 13px 0; cursor: pointer; font-weight: bold; letter-spacing: 0.2px; background: #ebebeb; color: #888; border: none; outline: none; font-size: 1.12em; transition: background 0.13s, color 0.13s; }
    .tab-ui.active { background: #fff; color: #2d9fd9; }
    .form-outer { width: 100vw; display: flex; justify-content: center; }
    .form-inner { width: 100%; max-width: 400px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 10px #1e90ff10; padding: 12px 16px 28px 16px; margin-top: 6px; margin-bottom: 0; display: flex; flex-direction: column; gap: 0.5em; }
    .form-group { margin-bottom: 16px; width: 100%; }
    .text-input-layout { position: relative; margin-bottom: 10px; width: 100%; }
    .text-input-label { font-size: 1em; color: #2d9fd9; font-weight: 600; margin-bottom: 4px; display: block; }
    .text-input-edit { width: 100%; padding: 14px 40px 14px 10px; font-size: 1.08em; border-radius: 10px; border: none; background: #f7f7f7; margin-bottom: 2px; border-bottom: 2px solid #e4e4e4; box-sizing: border-box; outline: none; transition: border 0.15s; }
    .text-input-edit:focus { border-bottom: 2px solid #61cbf8; background: #f0faff; }
    .material-icon-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; padding: 0; cursor: pointer; outline: none; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
    .material-icon-btn img { width: 24px; height: 24px; display: block; pointer-events: none; user-select: none; }
    .forgot-row { display: flex; justify-content: flex-end; margin-bottom: 12px; width: 100%; }
    .forgot-link { color: #2d9fd9; font-size: 1em; font-weight: 500; text-decoration: underline; background: none; border: none; cursor: pointer; padding: 0; outline: none; margin-top: -3px; }
    .msg { min-height: 28px; margin-top: 11px; text-align: center; font-weight: bold; font-size: 1em; width: 100%; word-break: break-word; display: flex; align-items: center; justify-content: center; }
    .msg.success { color: #18b857; }
    .msg.error { color: #ee4444; }
    .sign-in-btn { width: 100%; padding: 16px 0; border-radius: 12px; background: #61cbf8; color: #fff; border: none; font-weight: bold; font-size: 1.15em; margin-bottom: 8px; margin-top: 4px; cursor: pointer; transition: background 0.13s; box-shadow: 0 2px 8px #1e90ff11; letter-spacing: 0.5px; }
    .sign-in-btn:active { background: #3fbbe7; }
    .support-btn-row { display: flex; justify-content: center; margin-top: 22px; margin-bottom: 8px; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
    .support-btn { background: #ff8966; color: #fff; border: none; border-radius: 20px; padding: 15px 0; width: 100%; font-size: 1.13em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px #ffa5861a; transition: background 0.1s; letter-spacing: 0.5px; }
    .support-btn:active { background: #f76b44; }
    .support-note { font-size: 0.97em; color: #fc552b; text-align: center; margin-top: 2px; font-weight: 400; width: 100%; display: flex; align-items: center; justify-content: center; gap: 3px; }
    .msg .error-icon { font-size: 1.25em; margin-right: 7px; color: #f44336; }
    .spinner-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(255,255,255,0.7);
      z-index: 9999; display: flex; align-items: center; justify-content: center;
      transition: opacity 0.2s;
    }
    .spinner {
      border: 7px solid #e0f7fa;
      border-top: 7px solid #61cbf8;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .hidden { display: none !important; }
    @media (max-width: 520px) {
      .container { max-width: 100vw; width: 100vw; border-radius: 0 0 20px 20px; }
      .form-inner { max-width: 99vw; }
      .logo-top img { width: 95vw; height: 100px; }
      .tabs-ui, .support-btn-row { max-width: 99vw; }
      .spinner { width: 40px; height: 40px; border-width: 5px;}
    }
    #debug { display: none; }
  </style>
</head>
<body>
  <div class="main-bg"></div>
  <div class="container">
    <div class="logo-top">
      <img src="https://i.postimg.cc/VL4VbjvG/logo-ktgs.jpg" alt="KTGS Logo">
    </div>
    <div class="main-title">KTGS Go Green</div>
    <div class="tabs-ui">
      <button class="tab-ui active" id="tab-signup" type="button">Waste Management System</button>
    </div>
    <div id="debug"></div>
    <div class="form-outer">
      <form id="loginForm" autocomplete="on" class="form-inner">
        <div class="form-group">
          <div class="text-input-layout">
            <label for="loginUser" class="text-input-label">User: (ID Employee)</label>
            <input id="loginUser" type="text" class="text-input-edit" required autocomplete="username" placeholder="ID Employee" />
          </div>
        </div>
        <div class="form-group">
          <div class="text-input-layout">
            <label for="loginPassword" class="text-input-label">Password:</label>
            <input id="loginPassword" type="password" class="text-input-edit" required autocomplete="current-password" placeholder="Password" />
            <button type="button" class="material-icon-btn" id="togglePassBtn" aria-label="Toggle Password">
              <img id="togglePassImg" src="https://i.postimg.cc/NMCptXsL/1750920820059-0.jpg" alt="Show/Hide Password" />
            </button>
          </div>
        </div>
        <div class="forgot-row">
          <button type="button" class="forgot-link" id="forgotPasswordBtn">Forgot Password?</button>
        </div>
        <button type="submit" class="sign-in-btn" id="signInBtn">Log In</button>
        <div class="msg" id="loginMsg"></div>
      </form>
    </div>
    <div class="form-outer" style="display:none;" id="change-password-outer">
      <form id="change-password-form" autocomplete="off" class="form-inner" style="margin-top:0;">
        <input type="text" name="username" id="changePwdUsername" autocomplete="username" value="" style="display:none;">
        <div class="main-title" style="font-size:1em; color:#4DC247;">Change New Password</div>
        <div class="text-input-layout">
          <label class="text-input-label">Current Password</label>
          <input type="password" id="oldPassword" class="text-input-edit" required autocomplete="current-password">
        </div>
        <div class="text-input-layout">
          <label class="text-input-label">New Password</label>
          <input type="password" id="newPassword" class="text-input-edit" required autocomplete="new-password">
        </div>
        <div class="text-input-layout">
          <label class="text-input-label">Confirm New Password</label>
          <input type="password" id="confirmPassword" class="text-input-edit" required autocomplete="new-password">
        </div>
        <button id="btnChangePassword" type="button" class="sign-in-btn" style="margin-top:12px;">Change Password</button>
        <div class="msg" id="changePwdMsg"></div>
      </form>
    </div>
    <div class="support-btn-row">
      <button class="support-btn" id="supportBtn" type="button">Support</button>
    </div>
    <div class="support-note">
      <span style="font-size: 1.2em;">&#x26A0;</span>
      Calls will only be picked up from 9 am to 5 pm only
    </div>
  </div>
  <div id="spinnerBg" class="spinner-bg hidden">
    <div class="spinner"></div>
  </div>
  <script>
    // ====== CONFIG ======
    const LIFF_ID = "2007677132-Z38g9kmn";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzyFGNW06_ky5ZvmKHMcGGbLbuEpxgeLdqaR1665JRKnOoksXKxNav-ez3PbNBFFt6HxA/exec";
    // const HOME_LIFF_URL = "https://liff.line.me/2007678556-w9jamgJY";
    const HOME_LIFF_URL = "https://liff.line.me/2007678556-w9jamgJY";

    let _lineUserId = "";
    let liffReady = false;
    let _currentUserId = "";
    let _currentPassword = "";

    function showSpinner(show) {
      const spinnerBg = document.getElementById('spinnerBg');
      if (show) spinnerBg.classList.remove('hidden');
      else spinnerBg.classList.add('hidden');
    }

    // ใช้ localStorage สำหรับสถานะ login (per LINE userId)
    function getLoginKey() {
      return _lineUserId ? 'liffLoginSuccess_' + _lineUserId : '';
    }
    function isLoggedIn() {
      const key = getLoginKey();
      return key && localStorage.getItem(key) === '1';
    }
    function setLoggedIn() {
      const key = getLoginKey();
      if (key) localStorage.setItem(key, '1');
    }

    // ===== LIFF INIT =====
    async function initLiffUserId() {
      showSpinner(true);
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isInClient()) {
          alert("❌ กรุณาเปิดผ่านแอป LINE เท่านั้น");
          showSpinner(false);
          return;
        }
        if (!liff.isLoggedIn()) {
          liff.login();
          showSpinner(false);
          return;
        }
        const profile = await liff.getProfile();
        _lineUserId = profile.userId || "";
        liffReady = true;
        // หากเคย login แล้ว (per LINE userId) ให้ alert และ redirect ออกเสมอ
        if (isLoggedIn()) {
          alert("!!ปัจจุบันคุณได้เข้าสู่ระบบเรียบร้อยแล้ว กรุณารอสักครู่ระบบจะพาคุณไปที่หน้าหลักเพื่อทำรายการในลำดับถัดไป!!");
          redirectToHome();
          showSpinner(false);
          return;
        }
      } catch (err) {
        alert("❌ LIFF error: " + (err && err.message ? err.message : JSON.stringify(err)));
      }
      showSpinner(false);
    }
    initLiffUserId();

    // Toggle password visibility
    document.getElementById('togglePassBtn').addEventListener('click', function() {
      const pwdInput = document.getElementById('loginPassword');
      const img = document.getElementById('togglePassImg');
      if (pwdInput.type === 'password') {
        pwdInput.type = 'text';
        img.src = "https://i.postimg.cc/k5Pw5gBm/1750920820059-0-removebg-preview.png";
      } else {
        pwdInput.type = 'password';
        img.src = "https://i.postimg.cc/Kj0skSC5/1750920832875-0-removebg-preview.png";
      }
    });

    document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
      alert('กรุณาติดต่อ Support เพื่อขอรหัสผ่านใหม่');
    });

    document.getElementById('supportBtn').addEventListener('click', function() {
      window.open('tel:02 791 9800');
    });

    // --- LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!_lineUserId || !liffReady) {
        document.getElementById('loginMsg').textContent = "กรุณาเข้าใช้งานผ่าน LINE แอป";
        document.getElementById('loginMsg').classList.add("error");
        return;
      }
      // ถ้าเคย login แล้ว ห้ามเข้า (alert + redirect)
      if (isLoggedIn()) {
        alert("!!ปัจจุบันคุณได้เข้าสู่ระบบเรียบร้อยแล้ว กรุณารอสักครู่ระบบจะพาคุณไปที่หน้าหลักเพื่อทำรายการในลำดับถัดไป!!");
        redirectToHome();
        return;
      }
      const user = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const loginMsg = document.getElementById('loginMsg');
      loginMsg.textContent = "";
      loginMsg.className = "msg";
      if (!user || !password) {
        loginMsg.textContent = "กรุณากรอก User และ Password";
        loginMsg.classList.add("error");
        return;
      }
      showSpinner(true);
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ action: "login", user, password, lineUserId: _lineUserId })
        });
        const txt = await res.text();
        let data;
        try {
          data = JSON.parse(txt);
        } catch(e) {
          loginMsg.textContent = "เกิดข้อผิดพลาด: ระบบตอบกลับไม่ถูกต้อง";
          loginMsg.classList.add("error");
          showSpinner(false);
          return;
        }
        if (data.status === "ok") {
          loginMsg.textContent = "เข้าสู่ระบบสำเร็จ";
          loginMsg.classList.add("success");
          setLoggedIn();
          if (data.user && data.user.isFirstLogin) {
            document.getElementById('loginForm').style.display = "none";
            document.getElementById('change-password-outer').style.display = "flex";
            document.getElementById('changePwdUsername').value = user;
            _currentUserId = user;
            _currentPassword = password;
          } else {
            await registerLineUserToSheet(user, _lineUserId);
            setTimeout(() => redirectToHome(user, _lineUserId), 600);
          }
        } else {
          loginMsg.textContent = data.message || "เข้าสู่ระบบไม่สำเร็จ";
          loginMsg.classList.add("error");
        }
      } catch (err) {
        loginMsg.textContent = "เกิดข้อผิดพลาด: " + err.message;
        loginMsg.classList.add("error");
      }
      showSpinner(false);
    });

    // --- CHANGE PASSWORD ---
    document.getElementById('btnChangePassword').addEventListener('click', async function() {
      const oldPassword = document.getElementById('oldPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const changePwdMsg = document.getElementById('changePwdMsg');
      changePwdMsg.textContent = "";
      changePwdMsg.className = "msg";
      if (!oldPassword || !newPassword || !confirmPassword) {
        changePwdMsg.textContent = "กรุณากรอกข้อมูลให้ครบ";
        changePwdMsg.classList.add('error');
        return;
      }
      if (newPassword !== confirmPassword) {
        changePwdMsg.textContent = "รหัสผ่านใหม่และยืนยันไม่ตรงกัน";
        changePwdMsg.classList.add('error');
        return;
      }
      if (!_currentUserId || !_lineUserId) {
        changePwdMsg.textContent = "พบข้อผิดพลาด กรุณา login ใหม่";
        changePwdMsg.classList.add('error');
        return;
      }
      showSpinner(true);
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({
            action: "changePassword",
            user: _currentUserId,
            oldPassword,
            newPassword,
            lineUserId: _lineUserId
          })
        });
        const txt = await res.text();
        let data;
        try {
          data = JSON.parse(txt);
        } catch(e) {
          changePwdMsg.textContent = "เกิดข้อผิดพลาด: ระบบตอบกลับไม่ถูกต้อง";
          changePwdMsg.classList.add('error');
          showSpinner(false);
          return;
        }
        if (data.status === "ok") {
          changePwdMsg.textContent = "เปลี่ยนรหัสผ่านสำเร็จ กำลังเข้าสู่ระบบ...";
          changePwdMsg.classList.add('success');
          setLoggedIn();
          await registerLineUserToSheet(_currentUserId, _lineUserId);
          setTimeout(() => redirectToHome(_currentUserId, _lineUserId), 1200);
        } else {
          changePwdMsg.textContent = data.message || "เปลี่ยนรหัสผ่านไม่สำเร็จ";
          changePwdMsg.classList.add('error');
        }
      } catch (err) {
        changePwdMsg.textContent = "เกิดข้อผิดพลาด: " + err.message;
        changePwdMsg.classList.add('error');
      }
      showSpinner(false);
    });

    async function registerLineUserToSheet(empId, lineUserId) {
      try {
        await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ action: "registerLineUserId", user: empId, lineUserId: lineUserId })
        });
      } catch (e) {}
    }

    function redirectToHome(empId, lineUserId) {
      // ถ้ามีข้อมูลล่าสุดใช้จาก argument ถ้าไม่มีก็ใช้ global
      const emp = empId || _currentUserId || "";
      const lineId = lineUserId || _lineUserId || "";
      window.location.href = HOME_LIFF_URL + `?empId=${encodeURIComponent(emp)}&lineUserId=${encodeURIComponent(lineId)}`;
    }

    window.addEventListener('DOMContentLoaded', function() {
      showSpinner(false);
      document.getElementById('loginForm').style.display = "";
      document.getElementById('change-password-outer').style.display = "none";
      // ถ้ามี _lineUserId แล้ว และเคย login แล้ว (localStorage)
      // กรณี reload หรือเข้าจาก rich menu ให้ redirect ออกทันที
      // (ใน initLiffUserId จะ handle อีกทีหลัง liff พร้อม)
    });
  </script>
</body>
</html>
